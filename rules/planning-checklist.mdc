---
description: 做功能计划或 PRD 时先检查状态生命周期、防重、持久化，并与用户确认后再定稿
globs: "**/doc/**/*.md,**/*plan*.md,**/*prd*.md,**/plan.md,**/PRD*.md"
alwaysApply: false
---

# 功能规划前的检查与确认

当用户要求制定功能计划、写 PRD、或编写需求/设计文档，且需求涉及以下任一类时：

- **按用户/实体维度的状态或存储**（如画像、配置、历史记录）
- **异步/后台任务**（如定时蒸馏、批量处理）
- **持久化存储**（DB、文件、缓存）

在**写出最终方案或 plan 定稿之前**，你必须先：

1. **列出需要和用户确认的问题**，至少覆盖：
   - **状态生命周期**：何时创建/更新/清空？更新时是合并旧状态还是覆盖？（例如：蒸馏后是否清空历史；画像更新时是否基于旧画像合并。）
   - **防重与幂等**：同一条件是否会重复触发？如何避免重复执行？（例如：触发蒸馏后是否更新“已触发位置”，避免未清空前再次触发。）
   - **进程生命周期**：退出、重启、崩溃时，哪些状态需要持久化、哪些可以丢失？用户是否希望“尽量保存最近一段数据”？

2. **用简短列表或对话形式呈现上述问题**，并明确说明「请确认或补充，确认后再写最终方案」。

3. 用户确认（或表示无异议）后，再撰写完整计划/PRD，并在文档中体现已确认的结论（如“蒸馏后清空当轮历史”“蒸馏时读取并合并旧画像”“重启后从 SQLite 加载”等）。

若需求明显不涉及状态、存储或后台任务，可跳过本规则。
